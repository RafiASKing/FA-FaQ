======== FILE: .\admin.py ========
import streamlit as st
import pandas as pd
import time
import re
from src import database, utils
from src.config import ADMIN_PASSWORD, FAILED_SEARCH_LOG

# --- AUTH SYSTEM ---
if 'auth' not in st.session_state: st.session_state.auth = False

def login():
    if st.session_state.pass_input == ADMIN_PASSWORD: 
        st.session_state.auth = True
    else:
        st.error("Password salah")

if not st.session_state.auth:
    st.set_page_config(page_title="Admin Login")
    st.markdown("<h1 style='text-align: center;'>üîí Admin Login</h1>", unsafe_allow_html=True)
    c1, c2, c3 = st.columns([1,1,1])
    with c2:
        st.text_input("Password", type="password", key="pass_input", on_change=login)
    st.stop()

# --- MAIN UI SETUP ---
st.set_page_config(page_title="Admin Console", layout="wide")
st.title("üõ†Ô∏è Admin Console (Safe Mode)")
tags_map = utils.load_tags_config()

# State Management
if 'preview_mode' not in st.session_state: st.session_state.preview_mode = False
if 'draft_data' not in st.session_state: st.session_state.draft_data = {}

# Tabs
tab1, tab2, tab3, tab4, tab5 = st.tabs([
    "üìä Database", "‚ûï New FaQ", "‚úèÔ∏è Edit/Delete FaQ", "‚öôÔ∏è Config Tags", "üìà Analytics"
])

# === TAB 1: LIST DATA ===
with tab1:
    if st.button("üîÑ Refresh Data"):
        # CLEAR CACHE DISINI (MANUAL REFRESH)
        database.get_all_data_as_df.clear()
        st.rerun()
        
    df = database.get_all_data_as_df()
    st.dataframe(df, use_container_width=True, hide_index=True)

# === TAB 2: TAMBAH DATA (SMART EDITOR) ===
with tab2:
    # --- SMART CALLBACKS ---
    def add_text(text):
        """Menambahkan teks (Bold/List) ke akhir editor"""
        if 'in_a' in st.session_state:
            st.session_state.in_a += text

    def add_next_image_tag():
        """
        FITUR PINTAR (AUTO COUNTER):
        Otomatis scan teks, hitung jumlah tag [GAMBAR X], 
        lalu tambahkan [GAMBAR X+1].
        """
        current_text = st.session_state.get('in_a', "")
        matches = re.findall(r'\[GAMBAR\s*\d+\]', current_text, flags=re.IGNORECASE)
        next_num = len(matches) + 1
        
        tag_to_insert = f"\n[GAMBAR {next_num}]\n"
        st.session_state.in_a += tag_to_insert

    # --- PHASE 1: INPUT FORM ---
    if not st.session_state.preview_mode:
        # Load Draft (Anti-Amnesia Logic)
        default_tag = st.session_state.draft_data.get('tag', list(tags_map.keys())[0])
        default_judul = st.session_state.draft_data.get('judul', '')
        default_jawab = st.session_state.draft_data.get('jawab', '')
        default_key = st.session_state.draft_data.get('key', '')
        default_src = st.session_state.draft_data.get('src', '')
        
        try: idx_tag = list(tags_map.keys()).index(default_tag)
        except: idx_tag = 0

        st.subheader("üìù FaQ/SOP Baru")
        
        # Row 1: Module & Judul
        col_m, col_j = st.columns([1, 3])
        with col_m: i_tag = st.selectbox("Modul", list(tags_map.keys()), index=idx_tag, key="in_t")
        with col_j: i_judul = st.text_input("Judul Masalah (Pertanyaan/SOP)", value=default_judul, key="in_j")
            
        # Row 2: Smart Toolbar & Editor
        st.markdown("**Jawaban / Solusi:**")
        
        # Toolbar Layout
        tb1, tb2, tb3, tb_spacer = st.columns([1, 1, 2, 4])
        
        tb1.button("ùóï Bold", on_click=add_text, args=(" **teks tebal** ",), 
                   help="Tebalkan teks", use_container_width=True)
        
        tb2.button("Bars", on_click=add_text, args=("\n- Langkah 1\n- Langkah 2",), 
                   help="Buat List", use_container_width=True)
        
        # Tombol Ajaib
        tb3.button("+ Klik ini untuk add penanda gambar", on_click=add_next_image_tag, 
                   type="primary", icon="üñºÔ∏è", use_container_width=True,
                   help="Otomatis memasukkan tag [GAMBAR 1], [GAMBAR 2], dst.")

        # Text Area Utama
        i_jawab = st.text_area("Editor", value=default_jawab, height=300, key="in_a", label_visibility="collapsed")
        st.caption("üí° *Tips: Klik tombol 'üì∏' untuk memasukkan placeholder gambar secara urut.*")
        
        # Row 3: Meta Info & Upload
        c_k, c_s = st.columns(2)
        with c_k: 
            st.markdown("Term terkait / Bahasa User (HyDE) üëá")
            i_key = st.text_input("Hidden Label", value=default_key, key="in_k", 
                                  placeholder="Contoh: Gabisa login, User not found, Kok gagal discharge?...",
                                  label_visibility="collapsed",
                                  help="Masukkan kata-kata yang mungkin diketik user saat panik.")
            
        with c_s: 
            st.markdown("Sumber Info/Source URL")
            i_src = st.text_input("Hidden Label 2", value=default_src, key="in_s", label_visibility="collapsed")
        
        i_imgs = st.file_uploader("Upload Gambar", accept_multiple_files=True, key="in_i")
        
        st.divider()
        if st.button("üîç Lanjut ke Preview", type="primary", use_container_width=True):
            if not i_judul or not i_jawab:
                st.error("Judul & Jawaban wajib diisi!")
            else:
                # Simpan Draft ke Session State
                st.session_state.draft_data = {
                    "tag": i_tag, "judul": i_judul, "jawab": i_jawab,
                    "key": i_key, "src": i_src, "imgs": i_imgs
                }
                st.session_state.preview_mode = True
                st.rerun()

    # --- PHASE 2: PREVIEW & SUBMIT ---
    else:
        draft = st.session_state.draft_data
        
        st.info("üì± **Mode Preview:** Periksa tampilan sebelum Publish.")
        
        # Simulasi Tampilan User (Card)
        with st.container(border=True):
            hex_color = tags_map.get(draft['tag'], {}).get("color", "#808080")
            st.markdown(f"### <span style='color:{hex_color}'>[{draft['tag']}]</span> {draft['judul']}", unsafe_allow_html=True)
            st.caption(f"üîë Keywords/HyDE: {draft['key']}")
            st.divider()
            
            # Logic Render Gambar Sederhana untuk Preview
            parts = re.split(r'(\[GAMBAR\s*\d+\])', draft['jawab'], flags=re.IGNORECASE)
            imgs = draft['imgs'] or []
            
            for part in parts:
                match = re.search(r'\[GAMBAR\s*(\d+)\]', part, re.IGNORECASE)
                if match:
                    try:
                        idx = int(match.group(1)) - 1
                        if 0 <= idx < len(imgs):
                            st.image(imgs[idx], width=400, caption=f"Gambar {idx+1}")
                        else:
                            st.warning(f"‚ö†Ô∏è [GAMBAR {idx+1}] ditulis tapi file belum diupload.")
                    except: pass
                else:
                    if part.strip(): st.markdown(part)
        
        st.divider()
        c_back, c_save = st.columns([1, 3])
        
        with c_back:
            if st.button("‚¨ÖÔ∏è Edit Lagi", use_container_width=True):
                st.session_state.preview_mode = False
                st.rerun()
        
        with c_save:
            if st.button("üíæ PUBLISH KE DATABASE", type="primary", use_container_width=True):
                try:
                    with st.spinner("Menyimpan ke ChromaDB..."):
                        # 1. Simpan Gambar ke Disk
                        paths = utils.save_uploaded_images(draft['imgs'], draft['judul'], draft['tag'])
                        
                        # 2. Upsert ke DB
                        new_id = database.upsert_faq(
                            doc_id="auto",
                            tag=draft['tag'], 
                            judul=draft['judul'], 
                            jawaban=draft['jawab'], 
                            keyword=draft['key'], 
                            img_paths=paths, 
                            src_url=draft['src']
                        )
                        
                        st.balloons()
                        st.success(f"‚úÖ Data Tersimpan! ID Dokumen: {new_id}")
                        
                        # === [1] CLEAR CACHE (WAJIB) ===
                        database.get_all_data_as_df.clear()
                        
                        # Reset
                        st.session_state.preview_mode = False
                        st.session_state.draft_data = {}
                        time.sleep(2)
                        st.rerun()
                except Exception as e: 
                    st.error(f"Error Save: {e}")

# === TAB 3: EDIT/HAPUS ===
with tab3:
    st.header("‚úèÔ∏è Edit Data Lama")
    df_e = database.get_all_data_as_df()
    
    if not df_e.empty:
        opts = [f"{r['ID']} | {r['Judul']}" for _, r in df_e.iterrows()]
        sel = st.selectbox("Pilih Data", opts)
        
        if sel:
            sel_id = sel.split(" | ")[0]
            row = df_e[df_e['ID'] == sel_id].iloc[0]
            
            with st.form("edit_form"):
                curr = row['Tag']
                idx = list(tags_map.keys()).index(curr) if curr in tags_map else 0
                
                c_id, c_t = st.columns([1, 4])
                with c_id: st.text_input("ID", value=sel_id, disabled=True)
                with c_t: e_tag = st.selectbox("Modul", list(tags_map.keys()), index=idx)
                
                e_jud = st.text_input("Judul SOP", value=row['Judul'])
                e_jaw = st.text_area("Jawaban (Gunakan [GAMBAR X])", value=row['Jawaban'], height=200)
                e_key = st.text_input("Keyword / Bahasa User (HyDE)", value=row['Keyword'], help="Isi dengan variasi pertanyaan user.")
                e_src = st.text_input("Source URL", value=row['Source'])
                
                st.markdown(f"**Path Gambar Saat Ini:** `{row['Gambar']}`")
                e_new = st.file_uploader("Timpa Gambar Baru (Opsional)", accept_multiple_files=True)
                
                c_up, c_del = st.columns([1, 1])
                
                if c_up.form_submit_button("üíæ UPDATE DATA"):
                    p = row['Gambar']
                    if e_new: 
                        p = utils.save_uploaded_images(e_new, e_jud, e_tag)
                    
                    database.upsert_faq(sel_id, e_tag, e_jud, e_jaw, e_key, p, e_src)
                    st.toast("Data Updated!", icon="‚úÖ")
                    
                    # === [2] CLEAR CACHE (WAJIB) ===
                    database.get_all_data_as_df.clear()
                    
                    time.sleep(1)
                    st.rerun()
                
                if c_del.form_submit_button("üóëÔ∏è HAPUS PERMANEN", type="primary"):
                    database.delete_faq(sel_id)
                    st.toast("Data & Gambar Dihapus.", icon="üóëÔ∏è")
                    
                    # === [3] CLEAR CACHE (WAJIB) ===
                    database.get_all_data_as_df.clear()
                    
                    time.sleep(1)
                    st.rerun()

# === TAB 4: CONFIG ===
with tab4:
    st.subheader("‚öôÔ∏è Konfigurasi Tag")
    flat = [{"Tag":k, "Warna":v.get("color",""), "Sinonim":v.get("desc","")} for k,v in tags_map.items()]
    st.dataframe(pd.DataFrame(flat), use_container_width=True, hide_index=True)
    
    with st.expander("‚ûï Tambah / Update Tag (fitur edit/hapus tag masih perlu manual via file config)"):
        with st.form("conf_f", clear_on_submit=True):
            c1, c2 = st.columns(2)
            with c1: n_name = st.text_input("Nama Tag (ex: ED)")
            with c2: n_col = st.selectbox("Warna Badge", list(utils.COLOR_PALETTE.keys()))
            n_desc = st.text_input("Sinonim / Kepanjangan Singkatan", placeholder="ex: Emergency, Poli, Medical Record, Hemodialysis")
            
            if st.form_submit_button("Simpan"):
                if n_name:
                    hex_c = utils.COLOR_PALETTE[n_col]["hex"]
                    tags_map[n_name] = {"color": hex_c, "desc": n_desc}
                    utils.save_tags_config(tags_map)
                    st.toast("Konfigurasi Tersimpan!"); time.sleep(1); st.rerun()

# === TAB 5: ANALYTICS (FEEDBACK LOOP) ===
with tab5:
    st.subheader("üìà Pencarian Gagal (User Feedback)")
    st.caption("Daftar kata kunci yang dicari User tapi hasilnya < 32% (Tidak Relevan).")
    
    if utils.os.path.exists(FAILED_SEARCH_LOG):
        df_log = pd.read_csv(FAILED_SEARCH_LOG)
        
        col1, col2 = st.columns([4, 1])
        with col1:
            st.metric("Total Miss", len(df_log))
        with col2:
            if st.button("üóëÔ∏è Clear Log"):
                utils.os.remove(FAILED_SEARCH_LOG)
                st.rerun()
                
        if not df_log.empty:
            df_log = df_log.sort_values(by="Timestamp", ascending=False)
            st.dataframe(df_log, use_container_width=True)
    else:
        st.info("Belum ada data pencarian gagal. Sistem bekerja dengan baik!")

======== FILE: .\app.py ========
import streamlit as st
import os
import math
import re
import warnings
from src import database, utils

# --- 1. CONFIG & SUPPRESS WARNINGS ---
st.set_page_config(page_title="Siloam Knowledge Base", page_icon="üè•", layout="centered")

# Matikan warning deprecation
# (Kode lama dihapus karena sudah tidak supported di Streamlit baru)
warnings.filterwarnings("ignore")

# Load Konfigurasi Tag dari JSON (Single Source of Truth)
TAGS_MAP = utils.load_tags_config()

# CSS Styling
st.markdown("""
<style>
    div[data-testid="stExpander"] {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        background-color: white;
        margin-bottom: 10px;
    }
    div[data-testid="stExpander"] p {
        font-size: 15px;
        font-family: sans-serif;
    }
    .stApp {
        background-color: #FAFAFA;
    }
</style>
""", unsafe_allow_html=True)

# --- 2. HELPER FUNGSI ---

def get_badge_color_name(tag):
    """
    Menerjemahkan HEX Code dari tags_config.json menjadi Nama Warna Streamlit.
    """
    tag_data = TAGS_MAP.get(tag, {})
    hex_code = tag_data.get("color", "#808080").upper() 
    
    hex_to_name = {
        "#FF4B4B": "red",     # Merah (ED)
        "#2ECC71": "green",   # Hijau (OPD)
        "#3498DB": "blue",    # Biru (IPD/MR/Rehab)
        "#FFA500": "orange",  # Orange (Cashier)
        "#9B59B6": "violet",  # Ungu (Farmasi)
        "#808080": "gray",    # Abu (Umum)
        "#333333": "gray"     # Dark Gray
    }
    
    return hex_to_name.get(hex_code, "gray")

def render_image_safe(image_path):
    if image_path and os.path.exists(image_path):
        st.image(image_path, use_container_width=True)

def render_mixed_content(jawaban_text, images_str):
    if not images_str or str(images_str).lower() == 'none':
        st.markdown(jawaban_text)
        return

    img_list = images_str.split(';')
    img_list = [x for x in img_list if x.strip()]
    parts = re.split(r'(\[GAMBAR\s*\d+\])', jawaban_text, flags=re.IGNORECASE)
    
    # Case 1: Fallback (Gambar di bawah)
    if len(parts) == 1:
        st.markdown(jawaban_text)
        if img_list:
            st.markdown("---")
            cols = st.columns(min(3, len(img_list)))
            for idx, p in enumerate(img_list):
                clean_p = utils.fix_image_path_for_ui(p)
                if clean_p and os.path.exists(clean_p):
                    with cols[idx % 3]:
                        st.image(clean_p, use_container_width=True)
        return

    # Case 2: Inline (Diselipkan)
    for part in parts:
        match = re.search(r'\[GAMBAR\s*(\d+)\]', part, re.IGNORECASE)
        if match:
            try:
                idx = int(match.group(1)) - 1 
                if 0 <= idx < len(img_list):
                    clean_p = utils.fix_image_path_for_ui(img_list[idx])
                    if clean_p and os.path.exists(clean_p):
                        render_image_safe(clean_p)
                    else:
                        st.error(f"üñºÔ∏è File gambar tidak ditemukan: {clean_p}")
                else:
                    st.caption(f"*(Gambar #{idx+1} tidak tersedia)*")
            except ValueError: pass
        else:
            if part.strip(): st.markdown(part)

# --- 3. STATE MANAGEMENT ---
if 'page' not in st.session_state: st.session_state.page = 0
if 'last_query' not in st.session_state: st.session_state.last_query = ""
if 'last_filter' not in st.session_state: st.session_state.last_filter = ""

# --- 4. HEADER UI ---
st.title("‚ö°Fast Cognitive Search System")
st.caption("Smart Knowledge Base Retrieval")

col_q, col_f = st.columns([3, 1])
with col_q:
    query = st.text_input("Cari isu/kendala:", placeholder="Ketik masalah (cth: Kenapa Gagal Retur Obat, gagal discharge)...")
with col_f:
    # Ambil tag unik dari DB agar dropdown dinamis
    try:
        db_tags = database.get_unique_tags_from_db()
    except:
        db_tags = []
    all_tags = ["Semua Modul"] + (db_tags if db_tags else [])
    filter_tag = st.selectbox("Filter:", all_tags)

# --- 5. LOGIC PENCARIAN ---
if query != st.session_state.last_query or filter_tag != st.session_state.last_filter:
    st.session_state.page = 0
    st.session_state.last_query = query
    st.session_state.last_filter = filter_tag

results = []
is_search_mode = False

if query:
    is_search_mode = True
    # Tetap ambil agak banyak dari DB (misal 10 atau 20) buat kandidat
    raw = database.search_faq(query, filter_tag, n_results=50) 
    
    if raw['ids'][0]:
        for i in range(len(raw['ids'][0])):
            meta = raw['metadatas'][0][i]
            dist = raw['distances'][0][i]
            score = max(0, (1 - dist) * 100)
            
            # 1. TETAPKAN SYARAT MINIMUM 32%
            if score > 32:
                meta['score'] = score
                results.append(meta)
        
        # 2. üëá TAMBAHKAN BARIS INI (PEMOTONG) üëá
        # Ini artinya: "Ambil list results dari urutan ke-0 sampai ke-3 aja"
        results = results[:3]
else:
    raw_all = database.get_all_faqs_sorted()
    if filter_tag == "Semua Modul":
        results = raw_all
    else:
        results = [x for x in raw_all if x.get('tag') == filter_tag]

# --- 6. PAGINATION & DISPLAY ---
ITEMS_PER_PAGE = 10
total_docs = len(results)
total_pages = math.ceil(total_docs / ITEMS_PER_PAGE)

if st.session_state.page >= total_pages and total_pages > 0:
    st.session_state.page = 0

start_idx = st.session_state.page * ITEMS_PER_PAGE
end_idx = start_idx + ITEMS_PER_PAGE
page_data = results[start_idx:end_idx]

st.divider()

if not page_data:
    if is_search_mode:
        # Catat query gagal ke CSV
        try: utils.log_failed_search(query)
        except: pass
        
        # === CALL TO ACTION (WA BOT) ===
        st.warning(f"‚ùå Tidak ditemukan hasil yang relevan (Relevansi < 32%).")
        
        st.markdown("""
        ### üßê Belum ada solusinya?
        Sistem telah mencatat pencarianmu untuk perbaikan. Sementara itu, kamu bisa:
        
        1. Coba gunakan kata kunci yang lebih umum.
        2. Atau langsung request bantuan ke Tim IT Support:
        """)
        
        # GANTI NOMOR WA DI SINI (Format: 628xxx)
        wa_number = "6289635225253" 
        wa_text = f"Halo Admin, saya cari solusi tentang '{query}' tapi tidak ketemu di aplikasi FAQ."
        wa_link = f"https://wa.me/{wa_number}?text={wa_text.replace(' ', '%20')}"
        
        st.markdown(f'''
        <a href="{wa_link}" target="_blank" style="text-decoration: none;">
            <button style="
                background-color: #25D366; 
                color: white; 
                padding: 10px 20px; 
                border: none; 
                border-radius: 5px; 
                cursor: pointer;
                font-weight: bold;
                font-size: 16px;
                display: flex;
                align_items: center;
                gap: 8px;">
                üì± Chat WhatsApp Support
            </button>
        </a>
        ''', unsafe_allow_html=True)
        # ===============================
        
    else:
        st.info("üëã Selamat Datang. Database siap digunakan.")
else:
    st.markdown(f"**Menampilkan {start_idx+1}-{min(end_idx, total_docs)} dari {total_docs} data**")
    
    for item in page_data:
        # 1. Badge Warna Modul
        tag = item.get('tag', 'Umum')
        badge_color = get_badge_color_name(tag)
        
        # 2. Indikator Relevansi (CUSTOM COLOR LOGIC) üé®
        score_md = ""
        if item.get('score'):
            sc = item['score']
            
            # --- ATURAN WARNA BARU ---
            if sc > 80:
                # > 80%: "Ijo Tua" (Kita pake Green + BOLD + Bintang biar beda)
                # Streamlit cuma punya 1 green, jadi kita tebalkan biar tegas.
                score_md = f":green[**({sc:.0f}% Relevansi) üåü**]"
            
            elif sc > 50:
                # 50% - 80%: "Ijo Muda" (Green biasa/tipis)
                score_md = f":green[({sc:.0f}% Relevansi)]"
            
            elif sc > 36:
                # 37% - 50%: Orange
                score_md = f":orange[({sc:.0f}% Relevansi)]"
            
            else:
                # 32% - 36%: Merah
                score_md = f":red[({sc:.0f}% Relevansi)]"
            
        label = f":{badge_color}-background[{tag}] **{item.get('judul')}** {score_md}"
        
        with st.expander(label):
            render_mixed_content(item.get('jawaban_tampil', '-'), item.get('path_gambar'))
            if item.get('sumber_url') and len(str(item.get('sumber_url'))) > 3:
                st.markdown(f"üîó [Sumber Referensi]({item.get('sumber_url')})")

    if total_pages > 1:
        st.markdown("---")
        c1, c2, c3 = st.columns([1, 2, 1])
        with c1:
            if st.session_state.page > 0:
                if st.button("‚¨ÖÔ∏è Sebelumnya"):
                    st.session_state.page -= 1
                    st.rerun()
        with c3:
            if st.session_state.page < total_pages - 1:
                if st.button("Berikutnya ‚û°Ô∏è"):
                    st.session_state.page += 1
                    st.rerun()

======== FILE: .\bot_wa.py ========
import os
import requests
import uvicorn
from fastapi import FastAPI, Request, BackgroundTasks
from dotenv import load_dotenv
from src import database

# Load Environment Variables
load_dotenv()

app = FastAPI()

# --- CONFIG ---
FONNTE_TOKEN = os.getenv("FONNTE_TOKEN")

if not FONNTE_TOKEN:
    print("‚ö†Ô∏è WARNING: FONNTE_TOKEN belum diisi di .env!")

def send_wa_reply(target, message):
    """Kirim pesan balasan via Fonnte API"""
    headers = {
        "Authorization": FONNTE_TOKEN,
    }
    data = {
        "target": target,
        "message": message,
    }

    try:
        # Fonnte API Endpoint
        url = "https://api.fonnte.com/send"
        resp = requests.post(url, headers=headers, data=data)
        print(f"‚úÖ [Fonnte] Sent to {target} | Status: {resp.status_code}")
    except Exception as e:
        print(f"‚ùå [Fonnte] Error: {e}")

def process_logic(sender, incoming_msg):
    """
    Logic Sederhana & Cepat:
    1. Cek ada '@faq' gak? Kalau gak ada, ABORKAN.
    2. Ambil teks sisanya sebagai query.
    3. Cari Top 1 di Database.
    4. Kirim Jawaban.
    """
    
    # 1. VALIDASI TRIGGER
    # Pakai lower() biar @FAQ atau @faq tetap masuk
    if "@faq" not in incoming_msg.lower():
        return # Skip, jangan diproses

    # 2. BERSIHKAN QUERY
    # Hapus @faq, sisa teksnya adalah query pencarian
    query = incoming_msg.lower().replace("@faq", "").strip()
    
    if not query:
        send_wa_reply(sender, "‚ö†Ô∏è Silakan ketik pertanyaan setelah @faq.\nContoh: *@faq cara login nurse*")
        return

    print(f"üîç Searching: '{query}' from {sender}")

    # 3. CARI DI DATABASE (Rank 1 Only)
    # Filter selalu "Semua Modul" sesuai request
    results = database.search_faq_for_bot(query, filter_tag="Semua Modul")
    
    reply_text = ""
    
    # Cek apakah ada hasil
    if not results or not results['ids'][0]:
        reply_text = f"‚ùå Maaf, tidak ditemukan jawaban untuk: *'{query}'*\nCoba gunakan kata kunci lain."
    else:
        # AMBIL RANK 1 (Paling Relevan)
        meta = results['metadatas'][0][0]
        dist = results['distances'][0][0]
        score = max(0, (1 - dist) * 100) # Hitung skor persen
        
        # Format Jawaban: Judul & Isi
        reply_text += f"ü§ñ *FAQ Assistant* (Akurasi: {score:.0f}%)\n\n"
        reply_text += f"üìÇ Modul: *{meta['tag']}*\n"
        reply_text += f"‚ùì Tanya: *{meta['judul']}*\n"
        reply_text += f"‚úÖ Jawab: \n{meta['jawaban_tampil']}\n"
        
        # Cek Gambar
        if meta.get('path_gambar') and str(meta.get('path_gambar')).lower() != 'none':
            reply_text += "\nüñºÔ∏è *[Ada Gambar]* Cek aplikasi Web untuk visual detail."
            
        # Cek Sumber URL
        if meta.get('sumber_url'):
            reply_text += f"\nüîó Sumber: {meta.get('sumber_url')}"

    # 4. KIRIM BALASAN
    send_wa_reply(sender, reply_text)

@app.get("/")
def home():
    return {"status": "running", "mode": "Simple Bot @faq"}

@app.post("/webhook")
async def fonnte_webhook(request: Request, background_tasks: BackgroundTasks):
    """Jalur masuk pesan dari Fonnte"""
    try:
        body = await request.json()
        
        sender = body.get("sender")
        message = body.get("message")
        
        # Pastikan pesan valid & bukan status update dari device sendiri
        if sender and message and body.get("device_status") != "connect":
            # Jalankan di background biar Fonnte ga nunggu loading
            background_tasks.add_task(process_logic, sender, message)
            
        return {"status": "ok"}
    except Exception as e:
        print(f"Error Webhook: {e}")
        return {"status": "error"}

if __name__ == "__main__":
    # Port 8000 (Internal Container)
    uvicorn.run("bot_wa:app", host="0.0.0.0", port=8000)

======== FILE: .\docker-compose.yml ========
version: '3'

services:
# --- 1. CHROMA DB SERVER ---
  chroma-server:
    image: chromadb/chroma:latest
    container_name: faq_chroma_server
    restart: always
    ports:
      - "8000:8000"
    volumes:
      # KIRI: Folder Laptop (Tetap)
      # KANAN: Folder Container (UBAH JADI /data)
      - ./data/chroma_data:/data
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=False
      # Hapus baris PERSIST_DIRECTORY, biarkan dia pakai default /data

  # --- 2. WHATSAPP BOT (YANG HARUS MENGALAH) ---
  faq-bot:
    build: .
    container_name: faq_bot_wa
    restart: always
    ports:
      # KIRI = Pintu di Laptop Kamu (Host)
      # KANAN = Pintu di dalem Container (Code Python)
      - "8005:8000"  # <--- UBAH KIRI JADI 8005!
    depends_on:
      - chroma-server
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server
      - CHROMA_PORT=8000
    # Command tetap jalan di port 8000 container, tapi diakses dari luar via 8005
    command: uvicorn bot_wa:app --host 0.0.0.0 --port 8000

  # --- 3. USER APP ---
  faq-user:
    build: .
    container_name: faq_user_app
    restart: always
    ports:
      - "8501:8501"
    depends_on:
      - chroma-server
    volumes:
      - ./data:/app/data
      - ./images:/app/images
      - ./.streamlit:/app/.streamlit
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server # Nunjuk ke nama service di atas
      - CHROMA_PORT=8000
    command: streamlit run app.py --server.port=8501 --server.address=0.0.0.0

  # --- 4. ADMIN APP ---
  faq-admin:
    build: .
    container_name: faq_admin_app
    restart: always
    ports:
      - "8502:8502"
    depends_on:
      - chroma-server
    volumes:
      - ./data:/app/data
      - ./images:/app/images
      - ./.streamlit:/app/.streamlit
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server
      - CHROMA_PORT=8000
    command: streamlit run admin.py --server.port=8502 --server.address=0.0.0.0

  # --- 5. FRONTEND V2 (Port 8080) ---
  faq-web-v2:
    build: .
    container_name: faq_web_v2
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - chroma-server
    volumes:
      - ./data:/app/data
      - ./web_v2:/app/web_v2  # Mapping folder code v2
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server
      - CHROMA_PORT=8000
    # Jalankan uvicorn mengarah ke folder web_v2
    command: uvicorn web_v2.main:app --host 0.0.0.0 --port 8080

======== FILE: .\requirements.txt ========
streamlit==1.51.0
chromadb==1.3.4
pandas
google-genai
python-dotenv
fastapi
uvicorn
requests
# pysqlite3-binary PENTING untuk mengatasi limitasi SQLite lama di container Linux
pysqlite3-binary; sys_platform == 'linux'
watchdog
jinja2
python-multipart

======== FILE: .\test_bot.py ========
import os
import sys

# Setup path agar bisa import dari folder src
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from src import database
# IMPORT CONFIG DARI SINI
from src.config import BOT_MIN_SCORE, BOT_MIN_GAP

def simulasi_otak_bot(raw_text, filter_tag="Semua Modul"):
    # 1. BERSIHKAN INPUT
    clean_query = raw_text.replace("@botFaQ", "").replace("@botfaq", "").strip()
    
    if not clean_query:
        return "‚ö†Ô∏è Masukkan pertanyaan setelah @botFaQ."

    print(f"\nüß† Sedang memproses: '{clean_query}' [Tag: {filter_tag}]...")

    # 2. PANGGIL DATABASE
    results = database.search_faq_for_bot(clean_query, filter_tag)

    if not results or not results['ids'][0]:
        return "‚ùå Maaf, tidak ditemukan data yang relevan di database."

    # 3. EXTRACTION & SCORING
    candidates = []
    for i in range(len(results['ids'][0])):
        meta = results['metadatas'][0][i]
        dist = results['distances'][0][i]
        score = max(0, (1 - dist) * 100)
        
        # Cek apakah ada gambar
        has_image = False
        img_path = meta.get('path_gambar', 'none')
        if img_path and str(img_path).lower() != 'none':
            has_image = True

        candidates.append({
            "score": score,
            "judul": meta.get('judul'),
            "tag": meta.get('tag'),
            "jawaban": meta.get('jawaban_tampil'),
            "url": meta.get('sumber_url', '-'),
            "has_image": has_image
        })

    top1 = candidates[0]
    top2 = candidates[1] if len(candidates) > 1 else None

    # ==========================================
    # üöÄ LOGIKA CERDAS (PAKE CONFIG ENV)
    # ==========================================
    
    is_winner_absolute = False
    
    # Gunakan Variabel dari Config
    if top1['score'] >= BOT_MIN_SCORE:
        if top2:
            gap = top1['score'] - top2['score']
            if gap >= BOT_MIN_GAP: # Cek Gap dari Config
                is_winner_absolute = True
                print(f"DEBUG: Winner Mutlak! Score: {top1['score']:.1f}, Gap: {gap:.1f}")
            else:
                print(f"DEBUG: Score tinggi tapi saingan ketat. Gap cuma {gap:.1f}")
        else:
            is_winner_absolute = True

    # ==========================================
    # üì§ OUTPUT GENERATION
    # ==========================================

    response_text = ""

    if is_winner_absolute:
        response_text += f"üéØ *SOLUSI DITEMUKAN* (Akurasi: {top1['score']:.0f}%)\n"
        response_text += f"üìÇ Modul: {top1['tag']}\n\n"
        response_text += f"*{top1['judul']}*\n"
        response_text += f"{top1['jawaban']}\n\n"
        
        # Tambahan Indikator Gambar
        if top1['has_image']:
            response_text += "üñºÔ∏è *[Gambar Terlampir]*\n\n"
            
        if top1['url'] and len(top1['url']) > 3:
             response_text += f"üîó Sumber: {top1['url']}"

    else:
        response_text += "üîç *MUNGKIN INI YANG KAMU CARI:*\n"
        if top1['score'] < 25:
             response_text += "(Relevansi rendah, coba kata kunci lain)\n"
        
        limit = min(3, len(candidates))
        for i in range(limit):
            c = candidates[i]
            icon = "1Ô∏è‚É£" if i == 0 else ("2Ô∏è‚É£" if i == 1 else "3Ô∏è‚É£")
            link_txt = f" (üîó {c['url']})" if (c['url'] and len(c['url'])>3) else ""
            img_icon = " üñºÔ∏è" if c['has_image'] else ""
            
            response_text += f"\n{icon} *[{c['tag']}] {c['judul']}*{img_icon} {link_txt}"
            response_text += f"\n   ‚îî‚îÄ Relevansi: {c['score']:.1f}%"
    
    return response_text

if __name__ == "__main__":
    print("="*50)
    print("ü§ñ TEST BOT SIMULATOR (LOCAL)")
    print(f"‚öôÔ∏è Config Loaded: Min Score={BOT_MIN_SCORE}, Min Gap={BOT_MIN_GAP}")
    print("="*50)
    
    CURRENT_TAG_CONTEXT = "Semua Modul" 

    while True:
        try:
            user_input = input("\nüí¨ User: ")
            if user_input.lower() in ['exit', 'quit']:
                break
            balasan = simulasi_otak_bot(user_input, filter_tag=CURRENT_TAG_CONTEXT)
            print("-" * 20)
            print("ü§ñ Bot:\n" + balasan)
            print("-" * 20) 
        except KeyboardInterrupt:
            break

======== FILE: .\.streamlit\config.toml ========

[theme]
base="light"
primaryColor="#FF4B4B"
backgroundColor="#FFFFFF"
secondaryBackgroundColor="#F0F2F6"
textColor="#31333F"
font="sans serif"


======== FILE: .\src\config.py ========
import os
from dotenv import load_dotenv

# Load environment variables dari file .env
load_dotenv()

# --- API KEYS & AUTH ---
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
ADMIN_PASSWORD = os.getenv("ADMIN_PASSWORD", "veven")

if not GOOGLE_API_KEY:
    raise ValueError("‚ùå GOOGLE_API_KEY belum diset! Cek file .env.")

# --- PATHS CONFIGURATION ---
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
DB_PATH = os.path.join(BASE_DIR, "data", "faq_db")
TAGS_FILE = os.path.join(BASE_DIR, "data", "tags_config.json")
IMAGES_DIR = os.path.join(BASE_DIR, "images")
FAILED_SEARCH_LOG = os.path.join(BASE_DIR, "data", "failed_searches.csv")
COLLECTION_NAME = "faq_universal_v1"

# Setup Folder
os.makedirs(os.path.join(BASE_DIR, "data"), exist_ok=True)
os.makedirs(IMAGES_DIR, exist_ok=True)

# --- BOT LOGIC CONFIGURATION (NEW) ---
# Mengambil nilai dari .env, default ke 80.0 dan 10.0 jika tidak ada
try:
    BOT_MIN_SCORE = float(os.getenv("BOT_MIN_SCORE", "80.0"))
    BOT_MIN_GAP = float(os.getenv("BOT_MIN_GAP", "10.0"))
except ValueError:
    print("‚ö†Ô∏è Format angka di .env salah, menggunakan default (80.0 & 10.0)")
    BOT_MIN_SCORE = 80.0
    BOT_MIN_GAP = 10.0

======== FILE: .\src\database.py ========
# --- 1. FORCE USE NEW SQLITE (Wajib Paling Atas untuk Docker/Linux) ---
try:
    __import__('pysqlite3')
    import sys
    sys.modules['sqlite3'] = sys.modules.pop('pysqlite3')
except ImportError:
    pass

# --- 2. IMPORTS LENGKAP ---
import chromadb
import pandas as pd
import streamlit as st
import time
import functools
import random
import os
from google import genai
from google.genai import types
from .config import GOOGLE_API_KEY, DB_PATH, COLLECTION_NAME
from .utils import clean_text_for_embedding, load_tags_config

# --- 3. RETRY DECORATOR (SAFE CONCURRENCY) ---
def retry_on_lock(max_retries=10, base_delay=0.1):
    """
    Menangani error 'Database Locked' pada SQLite dengan Jitter Backoff.
    Aman digunakan oleh Streamlit maupun Bot eksternal.
    """
    def decorator(func):
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            retries = 0
            while retries < max_retries:
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    err_msg = str(e).lower()
                    if "locked" in err_msg or "busy" in err_msg:
                        retries += 1
                        sleep_time = base_delay * (1 + random.random())
                        time.sleep(sleep_time)
                    else:
                        raise e
            raise Exception("Database sedang sibuk (High Traffic), silakan coba lagi sesaat.")
        return wrapper
    return decorator

# --- 4. RAW FUNCTIONS (UNTUK BOT WA / API) ---
# Fungsi-fungsi ini TIDAK menggunakan @st.cache, jadi aman dipanggil script luar.

def _get_ai_client_raw():
    """Membuat koneksi ke Google Gemini (Tanpa Cache Streamlit)"""
    return genai.Client(api_key=GOOGLE_API_KEY)

def _get_db_client_raw():
    """
    Logika Cerdas:
    Cek apakah ada ENV Host Server?
    - Ada: Pake Mode Server (Production/Docker) üöÄ
    - Ga ada: Pake Mode File (Local Laptop) üìÇ
    """
    host = os.getenv("CHROMA_HOST")
    port = os.getenv("CHROMA_PORT")

    if host and port:
        # Client-Server Mode
        return chromadb.HttpClient(host=host, port=int(port))
    else:
        # Local Mode (Fallback)
        return chromadb.PersistentClient(path=DB_PATH)

def _generate_embedding_raw(text):
    """Generate Embedding langsung (Tanpa Cache Streamlit)"""
    client = _get_ai_client_raw()
    try:
        response = client.models.embed_content(
            model="models/gemini-embedding-001",
            contents=text,
            config=types.EmbedContentConfig(task_type="RETRIEVAL_DOCUMENT")
        )
        return response.embeddings[0].values
    except Exception as e:
        print(f"‚ö†Ô∏è Error Embedding AI: {e}")
        return []

# --- 5. STREAMLIT CACHED FUNCTIONS (UNTUK WEB APP) ---
# Fungsi ini khusus untuk Web App agar performa cepat (pake cache).

@st.cache_resource(show_spinner=False)
def get_db_client():
    return _get_db_client_raw()

@st.cache_resource(show_spinner=False)
def get_ai_client():
    return _get_ai_client_raw()

def get_collection():
    client = get_db_client()
    return client.get_or_create_collection(name=COLLECTION_NAME)

@st.cache_data(show_spinner=False)
def generate_embedding_cached(text):
    # Wrapper agar embedding di-cache oleh Streamlit
    return _generate_embedding_raw(text)

# --- 6. INTERNAL HELPER (ID GENERATOR) ---
def _get_next_id_internal(collection):
    data = collection.get(include=[])
    existing_ids = data['ids']
    
    if not existing_ids: return "1"
    
    numeric_ids = []
    for x in existing_ids:
        if x.isdigit(): 
            numeric_ids.append(int(x))
    
    if not numeric_ids: return "1"
    return str(max(numeric_ids) + 1)

# --- 7. CORE LOGIC (READ - USER WEB APP) ---
@retry_on_lock()
def search_faq(query_text, filter_tag=None, n_results=50):
    """
    Digunakan oleh app.py (Web). Menggunakan Embedding Ter-Cache.
    """
    col = get_collection()
    vec = generate_embedding_cached(query_text) # Pake Cache
    
    if not vec: 
        return {"ids": [[]], "metadatas": [[]], "distances": [[]]}

    # Pre-Filtering logic
    where_clause = {"tag": filter_tag} if (filter_tag and filter_tag != "Semua Modul") else None
    
    return col.query(
        query_embeddings=[vec],
        n_results=n_results,
        where=where_clause
    )

@retry_on_lock()
def get_all_faqs_sorted():
    col = get_collection()
    data = col.get(include=['metadatas'])
    
    results = []
    if data['ids']:
        for i, doc_id in enumerate(data['ids']):
            meta = data['metadatas'][i]
            try: id_num = int(doc_id)
            except: id_num = 0
            
            meta['id'] = doc_id
            meta['id_num'] = id_num
            results.append(meta)
            
    results.sort(key=lambda x: x.get('id_num', 0), reverse=True)
    return results

def get_unique_tags_from_db():
    col = get_collection()
    data = col.get(include=['metadatas'])
    unique_tags = set()
    if data['metadatas']:
        for meta in data['metadatas']:
            if meta and meta.get('tag'):
                unique_tags.add(meta['tag'])
    return sorted(list(unique_tags))

# --- 8. CORE LOGIC (WRITE - ADMIN) ---
# Admin selalu diakses via Streamlit, jadi aman pakai retry dan logic biasa.

@st.cache_data(show_spinner=False)
def get_all_data_as_df():
    col = get_collection()
    data = col.get(include=['metadatas', 'documents'])
    
    if not data['ids']: return pd.DataFrame()
    
    rows = []
    for i, doc_id in enumerate(data['ids']):
        meta = data['metadatas'][i]
        rows.append({
            "ID": doc_id,
            "Tag": meta.get('tag'),
            "Judul": meta.get('judul'),
            "Jawaban": meta.get('jawaban_tampil'),
            "Keyword": meta.get('keywords_raw'),
            "Gambar": meta.get('path_gambar'),
            "Source": meta.get('sumber_url'),
            "AI Context": data['documents'][i] if data['documents'] else ""
        })
    
    df = pd.DataFrame(rows)
    df['ID_Num'] = pd.to_numeric(df['ID'], errors='coerce').fillna(0)
    return df.sort_values('ID_Num', ascending=False).drop(columns=['ID_Num'])

@retry_on_lock()
def upsert_faq(doc_id, tag, judul, jawaban, keyword, img_paths, src_url):
    col = get_collection()
    
    final_id = str(doc_id)
    if doc_id == "auto" or doc_id is None:
        final_id = _get_next_id_internal(col)
    
    clean_jawaban = clean_text_for_embedding(jawaban)
    
    try:
        tags_config = load_tags_config()
        tag_desc = tags_config.get(tag, {}).get("desc", "")
    except:
        tag_desc = ""
    
    domain_str = f"{tag} ({tag_desc})" if tag_desc else tag

    # Format Embedding HyDE
    text_embed = f"""DOMAIN: {domain_str}
DOKUMEN: {judul}
VARIASI PERTANYAAN USER: {keyword}
ISI KONTEN: {clean_jawaban}"""
    
    # Gunakan cached embedding agar konsisten, toh ini proses lambat (write)
    vector = generate_embedding_cached(text_embed)
    
    col.upsert(
        ids=[final_id],
        embeddings=[vector],
        documents=[text_embed],
        metadatas=[{
            "tag": tag, 
            "judul": judul, 
            "jawaban_tampil": jawaban, 
            "keywords_raw": keyword,
            "path_gambar": img_paths,
            "sumber_url": src_url
        }]
    )
    return final_id

@retry_on_lock()
def delete_faq(doc_id):
    col = get_collection()
    try:
        data = col.get(ids=[str(doc_id)], include=['metadatas'])
        if data['metadatas'] and len(data['metadatas']) > 0:
            meta = data['metadatas'][0]
            img_str = meta.get('path_gambar', 'none')
            if img_str and img_str.lower() != 'none':
                paths = img_str.split(';')
                for p in paths:
                    clean_path = p.replace("\\", "/")
                    if os.path.exists(clean_path):
                        try:
                            os.remove(clean_path)
                            print(f"üóëÔ∏è Zombie File Deleted: {clean_path}")
                        except Exception as e:
                            print(f"‚ö†Ô∏è Gagal hapus file {clean_path}: {e}")
    except Exception as e:
        print(f"‚ö†Ô∏è Error cleaning images: {e}")

    col.delete(ids=[str(doc_id)])

# --- 9. SPECIAL FUNCTION FOR BOT WA (NO STREAMLIT DEPENDENCY) ---
@retry_on_lock()
def search_faq_for_bot(query_text, filter_tag="Semua Modul"):
    """
    Fungsi khusus untuk Bot WA / API External.
    MANDIRI: Membuka koneksi sendiri, Embedding sendiri tanpa Cache Streamlit.
    """
    # 1. Buka Koneksi Raw (Tanpa st.cache_resource)
    client = _get_db_client_raw()
    col = client.get_or_create_collection(name=COLLECTION_NAME)
    
    # 2. Embedding Raw (Tanpa st.cache_data)
    vec = _generate_embedding_raw(query_text)
    
    if not vec: 
        return None # Return None jika gagal embedding

    # 3. Filtering Logic
    where_clause = {"tag": filter_tag} if (filter_tag and filter_tag != "Semua Modul") else None
    
    # 4. Query
    results = col.query(
        query_embeddings=[vec],
        n_results=5, # Ambil Top 5 aja buat Bot
        where=where_clause
    )
    
    return results

======== FILE: .\src\utils.py ========
import os
import json
import re
import random
import string
import time
import csv
from datetime import datetime
from .config import TAGS_FILE, IMAGES_DIR, BASE_DIR 

# --- DAFTAR WARNA RESMI STREAMLIT (Restricted Palette) ---
# Admin hanya boleh memilih warna ini agar badge di UI User valid
COLOR_PALETTE = {
    "Merah":            {"hex": "#FF4B4B", "name": "red"},
    "Hijau":            {"hex": "#2ECC71", "name": "green"},
    "Biru":             {"hex": "#3498DB", "name": "blue"},
    "Orange":           {"hex": "#FFA500", "name": "orange"},
    "Ungu":             {"hex": "#9B59B6", "name": "violet"},
    "Abu-abu":          {"hex": "#808080", "name": "gray"},
    "Pelangi (Special)":{"hex": "#333333", "name": "rainbow"}
}

# --- 1. JSON TAG CONFIG ---
def load_tags_config():
    if not os.path.exists(TAGS_FILE):
        # Default struktur (Nested Dict)
        default_tags = {
            "ED": {"color": "#FF4B4B", "desc": "IGD, Emergency, Triage, Ambulans"},
            "OPD": {"color": "#2ECC71", "desc": "Rawat Jalan, Poli, Dokter Spesialis"},
            "IPD": {"color": "#3498DB", "desc": "Rawat Inap, Bangsal, Bed, Visite"},
            "Umum": {"color": "#808080", "desc": "General Info, IT Support"}
        }
        save_tags_config(default_tags)
        return default_tags
    with open(TAGS_FILE, "r") as f:
        return json.load(f)

def save_tags_config(tags_dict):
    with open(TAGS_FILE, "w") as f:
        json.dump(tags_dict, f, indent=4)

# --- 2. SAFE ID GENERATOR ---
def get_next_id_safe(collection):
    try:
        data = collection.get(include=[])
        existing_ids = data['ids']
        if not existing_ids: return "1"
        
        # Filter hanya ID angka agar sorting benar
        numeric_ids = []
        for x in existing_ids:
            if x.isdigit():
                numeric_ids.append(int(x))
        
        if not numeric_ids: return "1"
        return str(max(numeric_ids) + 1)
    except Exception:
        return str(int(time.time()))

# --- 3. IMAGE HANDLING ---
def sanitize_filename(text):
    # Membersihkan nama file dari karakter aneh
    return re.sub(r'[^\w\-_]', '', text.replace(" ", "_"))[:30]

def save_uploaded_images(uploaded_files, judul, tag):
    if not uploaded_files: return "none"
    
    saved_paths = []
    clean_judul = sanitize_filename(judul)
    target_dir = os.path.join(IMAGES_DIR, tag)
    os.makedirs(target_dir, exist_ok=True)
    
    for i, file in enumerate(uploaded_files):
        ext = file.name.split('.')[-1]
        # Tambah random suffix biar gak bentrok
        suffix = ''.join(random.choices(string.ascii_lowercase + string.digits, k=5))
        
        filename = f"{clean_judul}_{tag}_{i+1}_{suffix}.{ext}"
        full_path = os.path.join(target_dir, filename)
        
        with open(full_path, "wb") as f:
            f.write(file.getbuffer())
            
        # Simpan relative path agar portable (Docker/Local)
        rel_path = f"./images/{tag}/{filename}"
        saved_paths.append(rel_path)
        
    return ";".join(saved_paths)

def fix_image_path_for_ui(db_path):
    clean = str(db_path).strip('"').strip("'")
    if clean.lower() == "none": return None
    clean = clean.replace("\\", "/")
    if clean.startswith("./"):
        return clean 
    return clean

# --- 4. TEXT CLEANING FOR AI ---
def clean_text_for_embedding(text):
    """
    Menghapus tag [GAMBAR X] agar tidak menjadi noise bagi AI.
    Tapi MEMPERTAHANKAN markdown seperti **bold** atau list.
    Contoh: "Klik [GAMBAR 1] tombol save" -> "Klik tombol save"
    """
    if not text: return ""
    # Hapus pattern [GAMBAR angka] case insensitive
    clean = re.sub(r'\[GAMBAR\s*\d+\]', '', text, flags=re.IGNORECASE)
    # Hapus whitespace berlebih akibat penghapusan tadi
    return " ".join(clean.split())

def log_failed_search(query):
    """Mencatat pencarian yang hasilnya 0 ke file CSV"""
    filename = os.path.join(BASE_DIR, "data", "failed_searches.csv")
    
    # Cek header kalau file baru
    file_exists = os.path.exists(filename)
    
    try:
        with open(filename, mode='a', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            if not file_exists:
                writer.writerow(["Timestamp", "Query User"]) # Header
            
            writer.writerow([datetime.now().strftime("%Y-%m-%d %H:%M:%S"), query])
    except Exception as e:
        print(f"Gagal mencatat log: {e}")

======== FILE: .\src\__init__.py ========


======== FILE: .\web_v2\main.py ========
from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates
from fastapi.staticfiles import StaticFiles
import uvicorn
import os
import sys

# Trik biar bisa import 'src' dari folder luar
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from src import database, utils

app = FastAPI()

# Setup Templates (HTML)
current_dir = os.path.dirname(os.path.abspath(__file__))
templates = Jinja2Templates(directory=os.path.join(current_dir, "templates"))

# Load Config Tags (Biar warna badge sinkron sama Admin)
TAGS_MAP = utils.load_tags_config()

@app.get("/", response_class=HTMLResponse)
async def read_root(request: Request):
    return templates.TemplateResponse("index.html", {"request": request, "results": None})

@app.get("/search", response_class=HTMLResponse)
async def search(request: Request, q: str = ""):
    results = []
    if q:
        # Panggil logic database yang SAMA PERSIS dengan Streamlit & Bot
        # Filter "Semua Modul" biar general search
        raw = database.search_faq(q, filter_tag="Semua Modul", n_results=10)
        
        if raw and raw['ids'][0]:
            for i in range(len(raw['ids'][0])):
                meta = raw['metadatas'][0][i]
                dist = raw['distances'][0][i]
                score = max(0, (1 - dist) * 100)
                
                # Filter Score > 30% biar hasil sampah ga muncul
                if score > 30:
                    meta['score'] = int(score)
                    # Ambil warna badge dari config
                    tag_info = TAGS_MAP.get(meta['tag'], {})
                    meta['color'] = tag_info.get('color', '#808080')
                    
                    # Potong teks jawaban biar ga kepanjangan di preview
                    text = meta.get('jawaban_tampil', '')
                    meta['snippet'] = text[:200] + "..." if len(text) > 200 else text
                    
                    results.append(meta)
            
            # Ambil Top 5
            results = results[:5]

    return templates.TemplateResponse("index.html", {"request": request, "results": results, "query": q})

if __name__ == "__main__":
    uvicorn.run("main:app", host="0.0.0.0", port=8080, reload=True)

======== FILE: .\web_v2\__init__.py ========


