version: '3'

services:
  # --- 1. TYPESENSE (default) ---
  typesense:
    image: typesense/typesense:27.1
    container_name: faq_typesense
    restart: always
    ports:
      - "8118:8108"
    volumes:
      - ./data/typesense_data:/data
    environment:
      - TYPESENSE_API_KEY=xyz
      - TYPESENSE_DATA_DIR=/data

  # --- 2. EVOLUTION API ---
  wppconnect:
    container_name: faq_wppconnect
    # --- SOLUSI ANTI ERROR DOCKER HUB ---
    # Kita tidak download image, tapi BUILD langsung dari GitHub WPPConnect Resmi.
    # Ini akan download source code dan compile otomatis.
    build: https://github.com/wppconnect-team/wppconnect-server.git

    restart: always
    ports:
      - "21465:21465"
    environment:
      SECRET_KEY: ${WA_SESSION_KEY:-THISISMYSECURETOKEN}
      LOG_LEVEL: info
    volumes:
      # Token & Sesi
      - ./wpp_tokens:/home/wppconnect/tokens
      - ./wpp_sessions:/home/wppconnect/userData
      - ./wpp_sessions/config.json:/home/wppconnect/config.json
  # --- 4. BOT WA ---
  faq-bot:
    build: .
    container_name: faq_bot_wa
    restart: always
    ports:
      - "8005:8000"
    depends_on:
      typesense:
        condition: service_started
      wppconnect:
        condition: service_started
    env_file: .env
    environment:
      - VECTOR_DB=typesense
      - TYPESENSE_HOST=typesense
      - TYPESENSE_PORT=8108
      - TYPESENSE_API_KEY=xyz
      - WA_BASE_URL=http://wppconnect:21465
      - WA_SESSION_KEY=${WA_SESSION_KEY:-THISISMYSECURETOKEN}
      - PYTHONUNBUFFERED=1
    volumes:
      - ./data:/app/data
      - ./images:/app/images
    command: uvicorn main:bot_app --host 0.0.0.0 --port 8000
  # --- 5. USER APP ---
  faq-user:
    build: .
    container_name: faq_user_app
    restart: always
    ports:
      - "8501:8501"
    depends_on:
      - typesense
    volumes:
      - ./data:/app/data
      - ./images:/app/images
      - ./.streamlit:/app/.streamlit
    env_file: .env
    environment:
      - VECTOR_DB=typesense
      - TYPESENSE_HOST=typesense
      - TYPESENSE_PORT=8108
      - TYPESENSE_API_KEY=xyz
    command: streamlit run streamlit_apps/user_app.py --server.port=8501 --server.address=0.0.0.0
  # --- 6. ADMIN APP ---
  faq-admin:
    build: .
    container_name: faq_admin_app
    restart: always
    ports:
      - "8502:8502"
    depends_on:
      - typesense
    volumes:
      - ./data:/app/data
      - ./images:/app/images
      - ./.streamlit:/app/.streamlit
    env_file: .env
    environment:
      - VECTOR_DB=typesense
      - TYPESENSE_HOST=typesense
      - TYPESENSE_PORT=8108
      - TYPESENSE_API_KEY=xyz
    command: streamlit run streamlit_apps/admin_app.py --server.port=8502 --server.address=0.0.0.0
  # --- 7. FRONTEND V2 ---
  faq-web-v2:
    build: .
    container_name: faq_web_v2
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - typesense
    volumes:
      - ./data:/app/data
      - ./images:/app/images
      - ./templates:/app/templates
      - ./static:/app/static
    env_file: .env
    environment:
      - VECTOR_DB=typesense
      - TYPESENSE_HOST=typesense
      - TYPESENSE_PORT=8108
      - TYPESENSE_API_KEY=xyz
    command: uvicorn main:web_app --host 0.0.0.0 --port 8080
