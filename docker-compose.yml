version: '3'

services:
  # --- 1. CHROMA DB SERVER (TIDAK BERUBAH) ---
  chroma-server:
    image: chromadb/chroma:latest
    container_name: faq_chroma_server
    restart: always
    ports:
      - "8000:8000"
    volumes:
      - ./data/chroma_data:/data
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=False

  # --- 2. WAHA (WHATSAPP API) - BARU! ---
  waha:
    image: devlikepro/waha:latest
    container_name: faq_waha
    restart: always
    ports:
      - "3000:3000"  # Dashboard WAHA bisa dibuka di localhost:3000
    environment:
      # Menggunakan engine WEBJS (paling stabil untuk fitur dasar)
      - WHATSAPP_DEFAULT_ENGINE=WEBJS
      - WHATSAPP_SWAGGER_USERNAME=admin
      - WHATSAPP_SWAGGER_PASSWORD=admin
      - WAHA_LOG_LEVEL=info
    volumes:
      # Menyimpan sesi login WA agar tidak perlu scan QR ulang saat restart
      - ./waha_data:/app/.waha

  # --- 3. WHATSAPP BOT (LOGIC PYTHON) - DIUPDATE ---
  faq-bot:
    build: .
    container_name: faq_bot_wa
    restart: always
    ports:
      - "8005:8000"
    depends_on:
      - chroma-server
      - waha  # Bot harus menunggu WAHA siap
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server
      - CHROMA_PORT=8000
      - WAHA_BASE_URL=http://waha:3000 # URL internal antar container
    # Kita tetap pakai uvicorn untuk webhook handler
    command: uvicorn bot_wa:app --host 0.0.0.0 --port 8000

  # --- 4. USER APP (TIDAK BERUBAH) ---
  faq-user:
    build: .
    container_name: faq_user_app
    restart: always
    ports:
      - "8501:8501"
    depends_on:
      - chroma-server
    volumes:
      - ./data:/app/data
      - ./images:/app/images
      - ./.streamlit:/app/.streamlit
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server
      - CHROMA_PORT=8000
    command: streamlit run app.py --server.port=8501 --server.address=0.0.0.0

  # --- 5. ADMIN APP (TIDAK BERUBAH) ---
  faq-admin:
    build: .
    container_name: faq_admin_app
    restart: always
    ports:
      - "8502:8502"
    depends_on:
      - chroma-server
    volumes:
      - ./data:/app/data
      - ./images:/app/images
      - ./.streamlit:/app/.streamlit
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server
      - CHROMA_PORT=8000
    command: streamlit run admin.py --server.port=8502 --server.address=0.0.0.0

  # --- 6. FRONTEND V2 (TIDAK BERUBAH) ---
  faq-web-v2:
    build: .
    container_name: faq_web_v2
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - chroma-server
    volumes:
      - ./data:/app/data
      - ./web_v2:/app/web_v2
    env_file: .env
    environment:
      - CHROMA_HOST=chroma-server
      - CHROMA_PORT=8000
    command: uvicorn web_v2.main:app --host 0.0.0.0 --port 8080